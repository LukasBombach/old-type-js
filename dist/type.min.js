var core={},development={},settings={},oop={},event_api={},plugin_api={},environment={},utilities={},dom_utilities={},dom_walker={},text_walker={},range={},writer={},formatter={},caret={},selection_overlay={},selection={},input={},events_type={},events_input={},input_filters_caret={},input_filters_undo={},input_filters_command={},input_filters_remove={},input_filters_line_breaks={},undo_manager={},content={},actions_type={},actions_insert={},actions_remove={},actions_format={},core_api={},plugins_etherpad_typeetherpad={},plugins_etherpad_util={},plugins_etherpad_client={},plugins_etherpad_content={},plugins_etherpad_changeset={},plugins_etherpad_changes_change={},plugins_etherpad_changes_movement={},plugins_etherpad_changes_insertion={},plugins_etherpad_changes_removal={},plugins_etherpad_changes_formatting={},plugins_etherpad_changeset_serializer={},type={};core=function(t){function e(t){if(e.DomUtilities.isNode(t)&&(t={el:t}),!t.el)throw new Error("You must provide an element as root node for the editor's TypeContents.");this._root=null,this.options(t),this._writer=new e.Writer(this),this._formatter=new e.Formatter(this),this._undoManager=new e.UndoManager(this),this._caret=new e.Caret(this),this._selection=new e.Selection(this),this._input=new e.Input(this),e.trigger("ready",this)}return function(){this.typeEditor=!0,this._defaultOptions={el:null,undoSteps:20},this.options=function(t,n){return this._options=this._options||e.Utilities.extend({},this._defaultOptions),"string"==typeof t&&1===arguments.length?this._options[t]:("string"==typeof t&&2===arguments.length&&(t={options:n}),"object"==typeof t&&e.Utilities.extend(this._options,t),t.el&&(this._root=t.el),arguments.length?this:this._options)},this.createDomWalker=function(t,n){return n=e.DomWalker.loadOptions(n||{}),n.constrainingNode=n.constrainingNode||this._root,new e.DomWalker(t,n)},this.getRoot=function(){return this._root},this.getCaret=function(){return this._caret},this.getSelection=function(){return this._selection},this.getUndoManager=function(){return this._undoManager},this.getWriter=function(){return this._writer},this.getFormatter=function(){return this._formatter},this.getInput=function(){return this._input}}.call(e.prototype),e.fn=e.prototype,e.Events={},e.Actions={},t=e}(core),development=function(t){var e=core;return e.Development=function(){},function(){e.Development.log=function(t){return console&&console.log&&console.log.apply(console,arguments),e.Development},e.Development.debug=function(t){return console&&console.debug&&console.debug.apply(console,arguments),e.Development}}.call(e.Development),t=e.Development}(development),settings=function(t){var e=core;return e.Settings={prefix:"typejs-"},t=e.Settings}(settings),oop=function(t){var e=core;return e.OOP=function(){},function(){e.OOP.inherits=function(t,e){var n;t.prototype=Object.create(e.prototype),t.prototype.constructor=t;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t._super=e,t}}.call(e.OOP),t=e.OOP}(oop),event_api=function(t){var e=core;return function(){this.on=function(t,e){return this.eventCallbacks=this.eventCallbacks||{},this.eventCallbacks[t]=this.eventCallbacks[t]||[],this.eventCallbacks[t].push(e),this},this.off=function(t,e){this.eventCallbacks=this.eventCallbacks||{};var n=this.eventCallbacks[t]?this.eventCallbacks[t].indexOf(e):-1;return n>-1&&this.eventCallbacks[t].splice(n,1),this},this.trigger=function(t,e){var n;if(this.eventCallbacks=this.eventCallbacks||{},this.eventCallbacks[t])for(n=0;n<this.eventCallbacks[t].length;n+=1)this.eventCallbacks[t][n].apply(this,e);return this}}.call(e.fn),function(){this.on=function(t,e){return this.eventCallbacks=this.eventCallbacks||{},this.eventCallbacks[t]=this.eventCallbacks[t]||[],this.eventCallbacks[t].push(e),this},this.off=function(t,e){this.eventCallbacks=this.eventCallbacks||{};var n=this.eventCallbacks[t]?this.eventCallbacks[t].indexOf(e):-1;return n>-1&&this.eventCallbacks[t].splice(n,1),this},this.trigger=function(t,e){var n;if(this.eventCallbacks=this.eventCallbacks||{},this.eventCallbacks[t])for(n=0;n<this.eventCallbacks[t].length;n+=1)this.eventCallbacks[t][n].apply(this,e);return this}}.call(e),t}(event_api),plugin_api=function(t){var e=core;return function(){this.plugin=function(t,e){return this._plugins=this._plugins||{},null!==e&&(this._plugins[t]=e),this._plugins[t]},this.pluginInstance=function(t,e,n){return n=Array.prototype.slice.call(arguments,2),this._plugins=this._plugins||{},this._plugins[t]?this._plugins[t]:(this._plugins[t]=e instanceof Function?new(Function.prototype.bind.apply(e,n)):e,this._plugins[t])},this.callMethodFrom=function(t,e,n,i){var s=null;if(t.hasOwnProperty(e))s=t[e].apply(t,n);else{if(!i)throw new Error("Method "+e+"cannot be found in given module");s=i.apply(t,[e].concat(n))}return s===t?this:s}}.call(e.fn),t}(plugin_api),environment=function(t){var e=core;return e.Environment=function(){},function(){e.Environment.mac=-1!==navigator.appVersion.indexOf("Mac")}.call(e.Environment),t=e.Environment}(environment),utilities=function(t){var e=core;return e.Utilities=function(){},function(){e.Utilities.extend=function(t,e){var n,i;for(n=1;n<arguments.length;n+=1)for(i in arguments[n])arguments[n].hasOwnProperty(i)&&(arguments[0][i]=arguments[n][i]);return arguments[0]},e.Utilities.isFunction=function(t){return!!(t&&t.constructor&&t.call&&t.apply)}}.call(e.Utilities),t=e.Utilities}(utilities),dom_utilities=function(t){var e=core;return e.DomUtilities=function(){},function(){e.DomUtilities._containerId=e.Settings.prefix+"container",e.DomUtilities._singleTag=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,e.DomUtilities.addElement=function(t,n){var i=document.createElement(t);return n&&(i.className=e.Settings.prefix+n),this.getElementsContainer().appendChild(i),i},e.DomUtilities.removeElement=function(t){return t.parentNode.removeChild(t),this},e.DomUtilities.removeVisible=function(t,e){var n=t.parentNode;return t===e?t:t===document.body?t:null===n?null:(n.removeChild(t),this.isVisible(n)?n:this.removeVisible(n,e))},e.DomUtilities.removeTag=function(t,e,n){var i;if(n&&t.childNodes.length)for(i=0;i<t.childNodes.length;i+=1)this.removeTag(t.childNodes[i],e,n);return 1===t.nodeType&&t.tagName.toLowerCase()===e.toLowerCase()&&this.unwrap(t),this},e.DomUtilities.parseHTML=function(t){var e=document.createDocumentFragment(),n=e.appendChild(document.createElement("div"));return n.innerHTML=t,n.childNodes},e.DomUtilities.wrap=function(t,e){e=e.length?e:[e];var n,i=e[0],s=i.parentNode,r=i.nextSibling,o=document.createElement(t);for(r?s.insertBefore(o,r):s.appendChild(o),n=0;n<e.length;n+=1)o.appendChild(e[n]);for(n=0;n<e.length;n+=1)this.removeTag(e[n],t,!0);return o},e.DomUtilities.unwrap=function(t){var e=t.nextSibling,n=t.parentNode,i=t.childNodes;if(e)for(;i.length;)n.insertBefore(t.lastChild,e);else for(;i.length;)n.appendChild(t.firstChild);return n.removeChild(t),n.normalize(),this},e.DomUtilities.moveAfter=function(t,e){var n,i=t.nextSibling,s=t.parentNode;if(e=e.length?Array.prototype.slice.call(e,0):[e],i)for(n=0;n<e.length;n+=1)s.insertBefore(e[n],i);else for(n=0;n<e.length;n+=1)s.appendChild(e[n]);return this},e.DomUtilities.parent=function(t,e,n){for(;t.parentNode&&(!n||t!==n);){if(this.matches(t,e))return t;t=t.parentNode}return null},e.DomUtilities.matches=function(t,e){var n=t.matches||t.matchesSelector||t.msMatchesSelector||t.mozMatchesSelector||t.webkitMatchesSelector||t.oMatchesSelector;if(n)return n.call(t,e);for(var i=t.parentNode.querySelectorAll(e),s=i.length;s--;)if(i[s]===t)return!0;return!1},e.DomUtilities.getElementsContainer=function(){var t=window.document.getElementById(this._containerId);return null===t&&(t=window.document.createElement("div"),t.setAttribute("id",this._containerId),window.document.body.appendChild(t)),t},e.DomUtilities.containsButIsnt=function(t,e){return t!==e&&t.contains(e)},e.DomUtilities.isNode=function(t){return!(!t||!t.nodeType)},e.DomUtilities.isVisible=function(t){return!!t.offsetHeight},e.DomUtilities.order=function(t,e){return t===e?0:t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_FOLLOWING?-1:1}}.call(e.DomUtilities),t=e.DomUtilities}(dom_utilities),dom_walker=function(t){var e=core;return e.DomWalker=function(t,e){this.setNode(t),this.options(e)},function(){this.next=function(t){return this._setNodeIfNotNull(e.DomWalker._nextNode(this._node,this._options,t))},this.prefetchNext=function(t){return e.DomWalker._nextNode(this._node,this._options,t)},this.prev=function(t){return this._setNodeIfNotNull(e.DomWalker._prevNode(this._node,this._options,t))},this.prefetchPrev=function(t){return e.DomWalker._prevNode(this._node,this._options,t)},this.first=function(){var t=e.DomWalker.first(this._node,this._options.filter);return this._setNodeIfNotNull(t)},this.last=function(){var t=e.DomWalker.last(this._node,this._options.filter);return this._setNodeIfNotNull(t)},this.setNode=function(t){if(!t.nodeType)throw new Error("The given node is not a DOM node");return this._node=t,this},this.options=function(t){return this._options=e.DomWalker.loadOptions(t),this},this.getNode=function(){return this._node},this._setNodeIfNotNull=function(t){return null===t?null:(this._node=t,t)}}.call(e.DomWalker.prototype),function(){e.DomWalker._filterFunctions={text:"_isTextNodeWithContents",textNode:"_isTextNode",textual:"_resemblesText",visible:"_isVisible"},e.DomWalker.next=function(t,n){return e.DomWalker._nextNode(t,e.DomWalker.loadOptions(n))},e.DomWalker.prev=function(t,n){return e.DomWalker._prevNode(t,e.DomWalker.loadOptions(n))},e.DomWalker.first=function(t,n){var i=e.DomWalker.loadOptions(n);return i.constrainingNode=t,e.DomWalker._nextNode(t,i,!0)},e.DomWalker.last=function(t,n){var i=e.DomWalker.loadOptions(n);return i.constrainingNode=t,e.DomWalker._prevNode(t,i,!0)},e.DomWalker.loadOptions=function(t){return t=t||{},t.nodeType&&(t={constrainingNode:t}),("string"==typeof t||e.Utilities.isFunction(t))&&(t={filter:t}),t.filter&&(t.filter=e.DomWalker._loadFilter(t.filter)),t},e.DomWalker._loadFilter=function(t){var n;return"string"==typeof t?(n=e.DomWalker._filterFunctions[t],e.DomWalker[n]):t},e.DomWalker._nextNode=function(t,n,i){var s=t.parentNode;if(i===!0&&(!n.filter||n.filter(t)))return t;if(t.childNodes.length)return e.DomWalker._nextNode(t.childNodes[0],n,!0);if(null!==t.nextSibling)return e.DomWalker._nextNode(t.nextSibling,n,!0);for(;s!==n.constrainingNode;){if(null!==s.nextSibling)return e.DomWalker._nextNode(s.nextSibling,n,!0);s=s.parentNode}return null},e.DomWalker._prevNode=function(t,n,i){var s=t.parentNode;if(i===!0&&(!n.filter||n.filter(t)))return t;if(t.childNodes.length)return e.DomWalker._prevNode(t.lastChild,n,!0);if(null!==t.previousSibling)return e.DomWalker._prevNode(t.previousSibling,n,!0);for(;s!==n.constrainingNode;){if(null!==s.previousSibling)return e.DomWalker._prevNode(s.previousSibling,n,!0);s=s.parentNode}return null},e.DomWalker._isTextNode=function(t){return t.nodeType===Node.TEXT_NODE},e.DomWalker._isTextNodeWithContents=function(t){return t.nodeType===Node.TEXT_NODE&&/[^\t\n\r ]/.test(t.textContent)},e.DomWalker._resemblesText=function(t){return"br"===t.nodeName.toLocaleLowerCase()||e.DomWalker._isTextNodeWithContents(t)},e.DomWalker._isVisible=function(t){return!!t.offsetHeight}}.call(e.DomWalker),t=e.DomWalker}(dom_walker),text_walker=function(t){var e=core;return e.TextWalker=function(){},function(){e.TextWalker.offset=function(t,n,i,s){var r=new e.DomWalker(t,"textual"),o=r.next(!0),a=0;i=i||0,s=s||0;do{if(o===n)return a+s-i;a+=e.TextWalker._textLength(o)}while(o=r.next());return null},e.TextWalker.nodeAt=function(t,n,i){var s,r=new e.DomWalker(t,"textual"),o=r.first(),a=0;if(i=i||0,n+=i,n>=0&&n<=e.TextWalker._textLength(o))return{node:o,offset:n};if(0>n)for(;o=r.prev();){if(s=e.TextWalker._textLength(o),n>=a-s)return{node:o,offset:s+(n-a)};a-=s}else do{if(s=e.TextWalker._textLength(o),a+s>=n)return{node:o,offset:n-a};a+=s}while(o=r.next());return null},e.TextWalker._textLength=function(t){return"br"===t.nodeName.toLocaleLowerCase()?1:t.nodeValue.trim().length}}.call(e.TextWalker),t=e.TextWalker}(text_walker),range=function(t){var e=core;return e.Range=function(t,e,n,i){this.startContainer=t,this.startOffset=e,this.endContainer=n,this.endOffset=i,this.ensureStartNodePrecedesEndNode()},function(){this.elementEnclosingStartAndEnd=function(t,n){var i,s=e.DomUtilities.parent(this.startContainer,t,n);return null===s?null:(i=e.DomUtilities.parent(this.endContainer,t,n),s===i?s:null)},this.isInside=function(t){return t.contains(this.startContainer)&&t.contains(this.endContainer)},this.ensureIsInside=function(t){if(this.isInside(t))return!0;throw new Error("Range is not contained by given node.")},this.ensureStartNodePrecedesEndNode=function(){var t,e;return t=this.startContainer===this.endContainer,t&&this.startOffset<=this.endOffset?this:t&&this.startOffset>this.endOffset?this._swapOffsets():(e=this.startContainer.compareDocumentPosition(this.endContainer),e&=Node.DOCUMENT_POSITION_FOLLOWING,e||this._swapStartAndEnd(),this)},this.splitStartContainer=function(){var t;return 0===this.startOffset?this.startContainer:(t=this.startsAndEndsInSameNode(),this.startContainer=this.startContainer.splitText(this.startOffset),t&&(this.endContainer=this.startContainer,this.endOffset-=this.startOffset),this.startOffset=0,this.startContainer)},this.splitEndContainer=function(){return this.endOffset!==this.endContainer.length&&(this.endContainer=this.endContainer.splitText(this.endOffset).previousSibling,this.endOffset=this.endContainer.length),this.endContainer},this.getNativeRange=function(){var t=document.createRange();return t.setEnd(this.endContainer,this.endOffset),t.setStart(this.startContainer,this.startOffset),t},this.save=function(t){var e,n;return e=this.getStartOffset(t),n=this.startsAndEndsInSameNode()?e-this.startOffset+this.endOffset:this.getEndOffset(t),{from:t,start:e,end:n}},this.getLength=function(){return e.TextWalker.offset(this.startContainer,this.endContainer,this.startOffset,this.endOffset)},this.getStartOffset=function(t){return t?e.TextWalker.offset(t,this.startContainer,0,this.startOffset):parseInt(this.startOffset,10)},this.getEndOffset=function(t){return t?e.TextWalker.offset(t,this.endContainer,0,this.endOffset):parseInt(this.endOffset,10)},this.getStartElement=function(){return this.startContainer.parentNode},this.getEndElement=function(){return this.endContainer.parentNode},this.getStartTagName=function(){return this.getStartElement().tagName.toLowerCase()},this.getEndTagName=function(){return this.getEndElement().tagName.toLowerCase()},this.startTagIs=function(t){return this.getStartTagName()===t.toLowerCase()},this.endTagIs=function(t){return this.getEndTagName()===t.toLowerCase()},this.startsAndEndsInSameNode=function(){return this.startContainer===this.endContainer},this.isCollapsed=function(){return this.startOffset===this.endOffset&&this.startsAndEndsInSameNode()},this.mergeWith=function(t){var n,i;return n=e.DomUtilities.order(this.startContainer,t.startContainer),i=e.DomUtilities.order(this.endContainer,t.endContainer),0===n?this.startOffset=Math.min(this.startOffset,t.startOffset):1===n&&(this.startContainer=t.startContainer),0===i?this.endOffset=Math.max(this.endOffset,t.endOffset):-1===n&&(this.endContainer=t.endContainer),this},this._swapStartAndEnd=function(){return this._swapContainers(),this._swapOffsets(),this},this._swapContainers=function(){var t=this.startContainer;return this.startContainer=this.endContainer,this.endContainer=t,this},this._swapOffsets=function(){var t=this.startOffset;return this.startOffset=this.endOffset,this.endOffset=t,this}}.call(e.Range.prototype),function(){e.Range._getClientRectsIsBroken=null,e.Range.load=function(t){return e.Range.fromPositions(t.from,t.start,t.end)},e.Range.fromPositions=function(t,n,i){var s=e.TextWalker.nodeAt(t,n),r=e.TextWalker.nodeAt(t,i);return new e.Range(s.node,s.offset,r.node,r.offset)},e.Range.fromCurrentSelection=function(){var t=document.getSelection();return t.isCollapsed?null:e.Range.fromRange(t.getRangeAt(0))},e.Range.fromRange=function(t){var n=t.endContainer,i=t.endOffset;return 0===i&&n===e.DomWalker.next(t.startContainer.parentNode.nextSibling,"visible")&&(n=e.DomWalker.last(t.startContainer.parentNode,"text"),i=n.length),new e.Range(t.startContainer,t.startOffset,n,i)},e.Range.fromCaret=function(t,n){var i=t.getNode(),s=t.getNodeOffset(),r=e.TextWalker.nodeAt(i,n,s);return new e.Range(i,s,r.node,r.offset)},e.Range.fromElement=function(t){var n=e.DomWalker.first(t,"text"),i=e.DomWalker.last(t,"text");return new e.Range(n,0,i,i.nodeValue.length)},e.Range.fromMouseEvent=function(t){return e.Range.fromPoint(t.clientX,t.clientY)},e.Range.fromPoint=function(t,n){var i,s,r;if(document.caretPositionFromPoint)i=document.caretPositionFromPoint(t,n),s=i.offsetNode,r=i.offset;else{if(!document.caretRangeFromPoint)return e.Development.debug("This browser does not support caretPositionFromPoint or caretRangeFromPoint."),null;i=document.caretRangeFromPoint(t,n),s=i.startContainer,r=i.startOffset}return s.nodeType===Node.TEXT_NODE?new e.Range(s,r,s,r):(e.Development.debug("User clicked in a non-text node, cannot create range"),null)},e.Range._testGetClientRectsNeedsFix=function(){var t,n=document.createRange(),i=e.DomUtilities.addElement("p"),s=e.DomUtilities.addElement("p");return i.appendChild(document.createTextNode("aa")),s.appendChild(document.createTextNode("aa")),n.setStart(i.firstChild,1),n.setEnd(s.firstChild,1),t=n.getClientRects().length>2,e.DomUtilities.removeElement(i),e.DomUtilities.removeElement(s),t},e.Range._getClientRectsNeedsFix=function(){return"boolean"!=typeof e.Range._getClientRectsIsBroken&&(e.Range._getClientRectsIsBroken=this._testGetClientRectsNeedsFix()),e.Range._getClientRectsIsBroken},e.Range.getClientRects=function(t){if(!e.Range._getClientRectsNeedsFix())return t.getClientRects();for(var n=document.createRange(),i=t.endContainer,s=t.endOffset,r=[];i!==t.commonAncestorContainer;)n.setStart(i,0),n.setEnd(i,s),Array.prototype.push.apply(r,n.getClientRects()),s=Array.prototype.indexOf.call(i.parentNode.childNodes,i),i=i.parentNode;return n=t.cloneRange(),n.setEnd(i,s),Array.prototype.push.apply(r,n.getClientRects()),r}}.call(),t=e.Range}(range),writer=function(t){var e=core;return e.Writer=function(t){this._type=t,this._root=t.getRoot()},function(){this.insertText=function(t,e,n){var i=t.nodeValue;return t.nodeValue=e>0?i.substring(0,e)+n+i.substring(e,i.length):n+i,this},this.insertHTML=function(t,n,i){var s,r,o;for(i="string"==typeof i?e.DomUtilities.parseHTML(i):i,i=i.length?i:[i],i=Array.prototype.slice.call(i),o=t.splitText(n),r=o.parentNode,i[i.length-1].nodeType===Node.TEXT_NODE&&(o.nodeValue=i.pop().nodeValue+o.nodeValue,i.length||(t.nodeValue+=o.nodeValue,e.DomUtilities.removeElement(o))),s=i.length-1;s>=1;s-=1)r.insertBefore(i[s],o),o=i[s];return i.length&&i[0].nodeType===Node.TEXT_NODE?t.nodeValue+=i[0].nodeValue:i.length&&r.insertBefore(i[0],o),this},this.remove=function(t,n){var i,s,r,o,a,h,l,u,c;if(2===arguments.length&&(t=e.Range.fromCaret(t,n)),i=t.splitStartContainer(),s=t.splitEndContainer(),a=i.parentNode,r=this._type.createDomWalker(s,"textNode"),h=!1,!this._root.contains(i)||!this._root.contains(s))return e.Development.debug("The give startNode and endNode are not contained by the editor."),this;for(;!h;)o=r.getNode(),r.prev(),u=o===s&&0===t.endOffset,c=o!==i&&o===e.DomWalker.first(o.parentNode,"textNode"),(u||c)&&(l=o.parentNode,e.DomUtilities.moveAfter(r.getNode(),o.parentNode.childNodes),e.DomUtilities.removeVisible(l)),h=o===i,e.DomUtilities.removeVisible(o);return a.normalize(),this}}.call(e.Writer.prototype),t=e.Writer}(writer),formatter=function(t){var e=core;return e.Formatter=function(t){this._type=t},function(){this._inlineTags=["strong","em","u","s"],this._blockTags=["h1","h2","h3","h4","h5","h6","blockquote"],this.format=function(t,e,n){return e.ensureIsInside(this._type.getRoot()),this._handlerFor(t).apply(this,arguments)},this.removeFormat=function(t,n){var i,s=this._getStartNode(t,n),r=this._type.createDomWalker(s);do e.DomUtilities.removeTag(r.getNode(),t,!1),i=r.next();while(i&&!i.contains(n.endContainer));return this},this.inline=function(t,e,n){var i,s,r,o;return(o=e.elementEnclosingStartAndEnd(t))?this.removeInline(o,e):(s=this._getStartNode(t,e),r=this._getEndNode(t,e),n=Array.prototype.slice.call(arguments,2),i=[t,s,r].concat(n),this.insertInline.apply(this,i))},this.insertInline=function(t,n,i,s){for(var r,o=n,a=[],h=[];o&&!o.contains(i);)h.push(o),o=o.nextSibling;return o===i&&h.push(o),o&&e.DomUtilities.containsButIsnt(o,i)&&a.concat(this.insertInline(t,o.firstChild,i)),null===o&&(r=e.DomWalker.next(n.parentNode.lastChild,this._type.getRoot()),a.concat(this.insertInline(t,r,i))),a.push(e.DomUtilities.wrap(t,h)),a},this.removeInline=function(t,n){var i,s,r=t.tagName,o=e.Range.fromElement(t).save(this._type.getRoot()),a=n.save(this._type.getRoot());return e.DomUtilities.unwrap(t),i=e.Range.fromPositions(this._type.getRoot(),o.start,a.start),i.isCollapsed()||this.inline(r,i),s=e.Range.fromPositions(this._type.getRoot(),a.end,o.end),s.isCollapsed()||this.inline(r,s),this},this.block=function(t,e,n){return this.inline.apply(this,arguments)},this._getStartNode=function(t,e){return e.startTagIs(t)?e.getStartElement():e.splitStartContainer()},this._getEndNode=function(t,e){return e.endTagIs(t)?e.getEndElement():e.splitEndContainer()},this._handlerFor=function(t){return t=t.toLowerCase(),this._inlineTags.indexOf(t)>-1?this.inline:this._blockTags.indexOf(t)>-1?this.block:(e.Development.debug('Tag "'+t+'" not implemented'),this._noop)},this._noop=function(){return this}}.call(e.Formatter.prototype),t=e.Formatter}(formatter),caret=function(t){var e=core;return e.Caret=function(t){t=t||{constrainingNode:null,color:null},t.typeEditor===!0&&(t={constrainingNode:t.getRoot(),color:null}),e.DomUtilities.isNode(t)&&(t={constrainingNode:t,color:null}),this.callbacks={},this._constrainingNode=t.constrainingNode||document.body,this.caretEl=this._createElement(t.color)},function(){this._containerId=e.Settings.prefix+"caret-container",this.moveLeft=function(){if(this.offset<=this._visibleTextOffsets(this.textNode).start){var t=this._prevTextNode(this.textNode);null!==t&&this.moveTo(t,this._visibleTextOffsets(t).end)}else this._setOffset(this.offset-1);return this},this.moveRight=function(){if(this.offset>=this._visibleTextOffsets(this.textNode).end){var t=this._nextTextNode(this.textNode);null!==t&&this.moveTo(t,this._visibleTextOffsets(t).start)}else this._setOffset(this.offset+1);return this},this.moveUp=function(){for(var t,e=this.textNode,n=this.offset,i=e,s=this._createRange(e,n),r=this._getPositionsFromRange(s),o=this._getRectAtOffset(this.offset);null!==i&&(!r||r.top==o.top||r.left>o.left);)0>=n?(i=this._prevTextNode(e),null!==i&&(e=i,n=i.length)):n--,s.setStart(e,n),s.collapse(!0),t=r.left,r=this._getPositionsFromRange(s);return r.top<o.top&&(-1==this._compareDeltaTo(o.left,t,r.left)&&(n+=1),this.moveTo(e,n)),this},this.moveDown=function(){for(var t,e=this.textNode,n=this.offset,i=e,s=this._createRange(e,n),r=this._getPositionsFromRange(s),o=this._getRectAtOffset(this.offset),a=this._visibleTextOffsets(e);null!==i&&(!r||r.bottom==o.bottom||r.right<o.right);)n>=a.end?(i=this._nextTextNode(e),null!==i&&(e=i,a=this._visibleTextOffsets(e),n=0)):n++,s.setEnd(e,n),s.collapse(!1),t=r.right,r=this._getPositionsFromRange(s);return r.bottom>o.bottom&&(-1==this._compareDeltaTo(o.right,t,r.right)&&(n-=1),this.moveTo(e,n)),this},this.moveBy=function(t){var e=this.getOffset();return null===e?this:(this.setOffset(Math.max(0,this.getOffset()+t)),this)},this.moveTo=function(t,n){if(t.nodeType!==Node.TEXT_NODE&&(t=e.DomWalker.first(t,"text")),null===t)throw new Error("Node parameter must be or contain a text node");return t===this.textNode&&null===n?this:(this.textNode=t,this._setOffset(n||0),this)},this.insertText=function(t){if(this._callbacksFor("insertText",t),/^[\n\r]+$/.test(t)){var e=this.textNode.splitText(this.offset);return e.parentNode.insertBefore(document.createElement("br"),e),this.moveTo(e,0),this}var n=this.textNode.nodeValue;return this.textNode.nodeValue=this.offset>0?n.substring(0,this.offset)+t+n.substring(this.offset,n.length):t+n,this._setOffset(this.offset+t.length),this},this.removeCharacter=function(t){if(t=t||-1,this.offset<=0&&0>t||this.offset>=this.textNode.length&&t>0)return this;this._callbacksFor("removeCharacter",t);var e=this.textNode.nodeValue;return 0>t?(this.textNode.nodeValue=e.substring(0,this.offset+t)+e.substring(this.offset,e.length),this._setOffset(this.offset+t)):this.textNode.nodeValue=e.substring(0,this.offset)+e.substring(this.offset+t,e.length),this},this.registerCallback=function(t,e){return this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(e),this},this.destroy=function(){if("object"!=typeof this.caretEl)return this;var t=this._getElementContainer();return t.removeChild(this.caretEl),t.hasChildNodes()||t.parentNode.removeChild(t),this.caretEl=null,this},this.getOffset=function(){return this.textNode?e.TextWalker.offset(this._constrainingNode,this.textNode,0,this.offset):null},this.setOffset=function(t){var n=e.TextWalker.nodeAt(this._constrainingNode,t);return this.moveTo(n.node,n.offset),this},this.getNodeOffset=function(){return this.offset},this.getNode=function(){return this.textNode},this._setOffset=function(t){return this.offset=t,this._moveElToOffset(),this._resetBlink(),this._scrollIntoView(),this._callbacksFor("_setOffset"),this},this._moveElToOffset=function(){var t=this._getRectAtOffset(this.offset);return this._moveElTo(t.left,t.top),this._setElHeight(t.bottom-t.top),this},this._moveElTo=function(t,e){return this.caretEl.style.left=t+"px",this.caretEl.style.top=e+"px",this},this._setElHeight=function(t){return this.caretEl.style.height=t+"px",this},this._scrollIntoView=function(){return this},this._blink=function(){return this._removeClass(this.caretEl,"hide"),this._addClass(this.caretEl,"blink"),this},this._hide=function(){return this._removeClass(this.caretEl,"blink"),this._addClass(this.caretEl,"hide"),this},this._resetBlink=function(){var t=this.caretEl.cloneNode(!0);return this.caretEl.parentNode.replaceChild(t,this.caretEl),this.caretEl=t,this},this._callbacksFor=function(t,e){var n;if(e=Array.prototype.slice.call(arguments,1),this.callbacks[t])for(n=0;n<this.callbacks[t].length;n++)this.callbacks[t][n].apply(this,e)},this._nextTextNode=function(t,e){var n=t.parentNode;if(e===!0&&this._isTextNodeWithContents(t))return t;if(t.childNodes.length)return this._nextTextNode(t.childNodes[0],!0);if(null!==t.nextSibling)return this._nextTextNode(t.nextSibling,!0);for(;n!==this._constrainingNode;){if(null!==n.nextSibling)return this._nextTextNode(n.nextSibling,!0);n=n.parentNode}return null},this._prevTextNode=function(t,e){var n=t.parentNode;if(e===!0&&this._isTextNodeWithContents(t))return t;if(t.childNodes.length)return this._prevTextNode(t.childNodes[t.childNodes.length-1],!0);if(null!==t.previousSibling)return this._prevTextNode(t.previousSibling,!0);for(;n!==this._constrainingNode;){if(null!==n.previousSibling)return this._prevTextNode(n.previousSibling,!0);n=n.parentNode}return null},this._isTextNodeWithContents=function(t){return 3==t.nodeType&&/[^\t\n\r ]/.test(t.textContent)},this._visibleTextOffsets=function(t){var e=t.nodeValue.match(/^[\t\n\r ]+/g)||[""],n=t.nodeValue.match(/[\t\n\r ]+$/g)||[""];return{start:e[0].length,end:t.nodeValue.length-n[0].length}},this._addClass=function(t,e){return t.classList?t.classList.add(e):t.className+=" "+e,this},this._removeClass=function(t,e){if(t.classList)t.classList.remove(e);else{var n=new RegExp("(^|\\b)"+e.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(n," ")}return this},this._compareDeltaTo=function(t,e,n){var i=Math.abs(t-e),s=Math.abs(t-n);return i==s?0:s>i?-1:1},this._getRectAtOffset=function(t,e){return"number"==typeof t&&(e=t,t=this.textNode),this._getPositionsFromRange(this._createRange(t,e))},this._getPositionsFromRange=function(t){var e=this._getScrollPosition(),n=t.getClientRects()[0];return n?{top:n.top+e.top,right:n.right+e.left,bottom:n.bottom+e.top,left:n.left+e.left}:!1},this._getScrollPosition=function(){return{top:window.pageYOffset||document.documentElement.scrollTop,left:window.pageXOffset||document.documentElement.scrollLeft}},this._createRange=function(t,e,n,i){var s=window.document.createRange();return s.setEnd(i||t,n||e),s.setStart(t,e),s},this._createElement=function(t){var n=this._getElementContainer(),i=window.document.createElement("div");return i.className=e.Settings.prefix+"caret "+t,n.appendChild(i),i},this._getElementContainer=function(){var t=window.document.getElementById(this._containerId);return null===t&&(t=window.document.createElement("div"),t.setAttribute("id",this._containerId),window.document.body.appendChild(t)),t}}.call(e.Caret.prototype),t=e.Caret}(caret),selection_overlay=function(t){var e=core;return e.SelectionOverlay=function(t,e,n,i,s){s!==!1&&this.show(t,e,n,i),this._setValues(t,e,n,i),this._anchor={x:t,y:e}},function(){this.set=function(t,e,n,i){return"left"===t&&(t=this._textleft(),n=null),"right"===t&&(t=null,n=this._textRight()),"line"===t&&(t=this._textleft(),n=this._textRight()),t=void 0===t?null:t,e=void 0===e?null:e,n=void 0===n?null:n,i=void 0===i?null:i,this._draw(t,e,n,i),this._setValues(t,e,n,i),this},this.show=function(t,e,n,i){return this._el=this._createElement(),this._draw(t,e,n,i),this},this.hide=function(){return e.DomUtilities.removeElement(this._el),this._el=null,this},this.visible=function(){return!(this.x1===this.x2||this.y1===this.y2)},this.remove=function(){return this._el&&e.DomUtilities.removeElement(this._el),this._el=null,this.x1=null,this.y1=null,this.x2=null,this.y2=null,this._anchor=null,this},this._setValues=function(t,e,n,i){return null!==t&&(this.x1=t),null!==e&&(this.y1=e),null!==n&&(this.x2=n),null!==i&&(this.y2=i),this},this._draw=function(t,e,n,i){return this._el?(null!==t&&t!==this.x1&&(this._el.style.left=t+"px"),(null!==t&&t!==this.x1||null!==n&&n!==this.x2)&&(t=null!==t?t:this.x1,n=null!==n?n:this.x2,this._el.style.width=n-t+"px"),null!==e&&e!==this.y1&&(this._el.style.top=e+"px"),(null!==e&&e!==this.y1||null!==i&&i!==this.y2)&&(e=null!==e?e:this.y1,i=null!==i?i:this.y2,this._el.style.height=i-e+"px"),this):this},this._createElement=function(){return e.DomUtilities.addElement("div","selection")}}.call(e.SelectionOverlay.prototype),e.SelectionOverlay.fromRange=function(t){var n=e.SelectionOverlay._getPositionsFromRange(t);return new e.SelectionOverlay(n.left,n.top,n.right,n.bottom,!0,t.startContainer)},e.SelectionOverlay._getScrollPosition=function(){return{top:window.pageYOffset||document.documentElement.scrollTop,left:window.pageXOffset||document.documentElement.scrollLeft}},e.SelectionOverlay._getPositionsFromRange=function(t){var n=e.SelectionOverlay._getScrollPosition(),i=t.getClientRects()[0];return i?{top:i.top+n.top,right:i.right+n.left,bottom:i.bottom+n.top,left:i.left+n.left}:null},t=e.SelectionOverlay}(selection_overlay),selection=function(t){var e=core;return e.Selection=function(t){this._init(t)},function(){this.beginAt=function(t,e){return this.unselect(),this._setAnchor(t,e),this._startRangeAt(this._anchor.node,this._anchor.offset)},this.moveTo=function(t,n){var i=e.Range.fromPoint(t,n);return this._addElement(i.endContainer),t<this._anchor.x||n<this._anchor.y?this._moveStartTo(i.endContainer,i.endOffset):this._moveEndTo(i.endContainer,i.endOffset),this},this.getContent=function(){return this._range?this._range.cloneContents():null},this.selectWordAt=function(t,e){var n,i,s=new RegExp("\\s"),r=this._range.endContainer.nodeValue.length,o=this._range.startOffset,a=this._range.endOffset,h=!1,l=!1;this.beginAt(t,e);do n=this._range.startContainer.nodeValue.charAt(this._range.startOffset-1),o>1&&!s.test(n)?o>1&&(o-=1,this._range.setStart(this._range.startContainer,o)):h=!0;
while(!h);do i=this._range.endContainer.nodeValue.charAt(this._range.endOffset),r>a&&!s.test(i)?r>a&&(a+=1,this._range.setEnd(this._range.endContainer,a)):l=!0;while(!l);return this._imitateRangeAppending(),this},this.unselect=function(){return this._removeOverlays(),this._elements={},this._range=null,this._anchor=null,this},this.save=function(){return this.getRange().save(this._root)},this.restore=function(t){return this.unselect(),this._range=e.Range.load(t).getNativeRange(),this._imitateRangeAppending(),this},this.getRange=function(){return e.Range.fromRange(this._range)},this.getNativeRange=function(){return this._range},this.getStart=function(){return this._range?{node:this._range.startContainer,offset:this._range.startOffset}:null},this.getEnd=function(){return this._range?{node:this._range.endContainer,offset:this._range.endOffset}:null},this.collapsed=function(){return!this._overlays.length||!this._overlays[0].visible()},this._init=function(t){return this._root=t.getRoot(),this.unselect()},this._startRangeAt=function(t,e){return this._range=window.document.createRange(),this._range.setStart(t,e),this._range.setEnd(t,e),this},this._moveStartTo=function(t,e){return this._range.setStart(t,e),this._range.setEnd(this._anchor.node,this._anchor.offset),this._imitateRangePrepending(),this},this._moveEndTo=function(t,e){return this._range.setStart(this._anchor.node,this._anchor.offset),this._range.setEnd(t,e),this._imitateRangeAppending(),this},this._setAnchor=function(t,n){var i=e.Range.fromPoint(t,n);return this._anchor={x:t,y:n,node:i.startContainer,offset:i.startOffset},this._addElement(this._anchor.node),this},this._imitateRangePrepending=function(){var t,n,i,s=e.Range.getClientRects(this._range);for(i=s.length-1;i>=0;i-=1)this._overlays[i]?this._overlays[i].set(s[i].left,s[i].top,s[i].right,s[i].bottom):(t=!this._matchesElementDimensions(s[i]),n=new e.SelectionOverlay(s[i].left,s[i].top,s[i].right,s[i].bottom,t),this._overlays.unshift(n));for(;this._overlays.length>s.length;)this._overlays.shift().remove();return this},this._imitateRangeAppending=function(){var t,n,i,s=this._range.getClientRects();for(i=0;i<s.length;i+=1)this._overlays[i]?this._overlays[i].set(s[i].left,s[i].top,s[i].right,s[i].bottom):(t=!this._matchesElementDimensions(s[i]),n=new e.SelectionOverlay(s[i].left,s[i].top,s[i].right,s[i].bottom,t),this._overlays.push(n));for(;this._overlays.length>s.length;)this._overlays.pop().remove();return this},this._addElement=function(t){var e,n;return t=3===t.nodeType?t.parentNode:t,e=t.getBoundingClientRect(),n=this._stringifyRect(e),this._elements[n]=e,this},this._matchesElementDimensions=function(t){var e=this._stringifyRect(t);return this._elements.hasOwnProperty(e)},this._removeOverlays=function(){var t;for(this._overlays=this._overlays||[],t=0;t<this._overlays.length;t+=1)this._overlays[t].remove();return this._overlays=[],this},this._stringifyRect=function(t){var e=t.top.toString(),n=t.left.toString(),i=t.bottom.toString(),s=t.right.toString();return e+n+i+s}}.call(e.Selection.prototype),t=e.Selection}(selection),input=function(t){var e=core;return e.Input=function(t){this._type=t,this._content=new e.Content(t),this._writer=t.getWriter(),this._caret=t.getCaret(),this._selection=this._type.getSelection(),this._el=this._createElement(),this._elStyle=this._el.style,this._caretStyle=this._caret.caretEl.style,this._loadFilters(),this._bindEvents()},function(){this.addFilter=function(t,e){return this._filters=this._filters||{},this._filters[t]=e,this},this.removeFilter=function(t){return this._filters=this._filters||{},this._filters.name&&delete this._filters.name,this},this.getContent=function(){return this._content},this._loadFilters=function(){return this._filters=this._filters||{},this._filters.undo=new e.Input.Filter.Undo(this._type,this),this._filters.cmd=new e.Input.Filter.Command(this._type,this),this._filters.caret=new e.Input.Filter.Caret(this._type,this),this._filters.remove=new e.Input.Filter.Remove(this._type,this),this._filters.lineBreaks=new e.Input.Filter.LineBreaks(this._type,this),this},this._bindEvents=function(){return this._bindKeyDownEvents(),this._bindInputEvents(),this._bindMouseEvents(),this},this._bindKeyDownEvents=function(){return this._el.addEventListener("keydown",function(t){this._processFilterPipeline(t)}.bind(this),!1),this},this._bindInputEvents=function(){return this._el.addEventListener("input",function(t){this._onInput(t)}.bind(this),!1),this},this._bindMouseEvents=function(){function t(t){o._selection.moveTo(t.clientX,t.clientY)}function e(){document.removeEventListener("mousemove",t,!1),document.removeEventListener("mouseup",e,!1),o._el.innerHTML="",o._el.appendChild(o._selection.getContent()),document.execCommand("selectAll",!1,null)}function n(n){1===n.which&&(n.preventDefault(),o._caret._hide(),o._selection.beginAt(n.clientX,n.clientY),document.addEventListener("mousemove",t,!1),document.addEventListener("mouseup",e,!1))}function i(t){o._selection.collapsed()&&(o._moveCaretToMousePosition(t.clientX,t.clientY),o._caret._blink()),o._focusInput()}function s(t){o._selection.selectWordAt(t.clientX,t.clientY)}function r(t){3===t.which&&(o._moveCaretToMousePosition(t.clientX,t.clientY),o._caret._blink(),o._moveElToPosition(t.clientX-3,t.clientY-3),o._el.focus(),document.execCommand("selectAll",!1,null))}var o=this;return this._type.getRoot().addEventListener("contextmenu",r,!1),this._type.getRoot().addEventListener("mousedown",n,!1),this._type.getRoot().addEventListener("mouseup",i,!1),this._type.getRoot().addEventListener("dblclick",s,!1),this},this._processFilterPipeline=function(t){var n,i=e.Events.Input.fromKeyDown(t);for(n in this._filters)if(this._filters.hasOwnProperty(n)&&(this._processFilter(this._filters[n],i),i.canceled)){t.preventDefault();break}return i.canceled||(this._el.textContent.length>2?this._type.trigger("paste",[i]):this._type.trigger("input",[i])),i},this._processFilter=function(t,e){var n=t.keys[e.key];return n&&t[n](e),!e.canceled&&t.keys.all&&t[t.keys.all](e),e},this._onInput=function(t){return this._content.insert(this._caret.textNode,this._caret.offset,this._el.textContent),this._caret._setOffset(this._caret.offset+this._el.textContent.length),this._el.innerHTML="",this},this._moveCaretToMousePosition=function(t,n){var i=e.Range.fromPoint(t,n);return 3===i.startContainer.nodeType&&(this._caret.moveTo(i.startContainer,i.startOffset),this._caret._blink()),this},this._moveElToPosition=function(t,e){return this._el.style.left=t+"px",this._el.style.top=e+"px",this},this._focusInput=function(t){return t?this._el.focus():window.setTimeout(function(){this._el.focus()}.bind(this),0),this},this._createElement=function(){var t=document.createElement("div");return t.setAttribute("contenteditable","true"),t.className=e.Settings.prefix+"input",e.DomUtilities.getElementsContainer().appendChild(t),t}}.call(e.Input.prototype),e.Input.Filter={},t=e.Input}(input),events_type=function(t){var e=core;return e.Events.Type=function(){this.canceled=!1},function(){this.data=function(t,n){return this._data=this._data||{},"string"==typeof t&&1===arguments.length?this._data[t]:("string"==typeof t&&2===arguments.length&&(t={options:n}),"object"==typeof t&&e.Utilities.extend(this._data,t),arguments.length?this:this._data)},this.cancel=function(t){return this.canceled=t!==!1,this}}.call(e.Events.Type.prototype),t=e.Events.Type}(events_type),events_input=function(t){var e=core;return e.Events.Input=function(t){t=t||{},this.key=t.key||null,this.keyCode=t.keyCode||null,this.shift=t.shift||!1,this.alt=t.alt||!1,this.ctrl=t.ctrl||!1,this.meta=t.meta||!1,this.cmd=!e.Environment.mac&&t.ctrl||e.Environment.mac&&t.meta,this.canceled=!1},e.OOP.inherits(e.Events.Input,e.Events.Type),e.Events.Input.keyDownNames={8:"backspace",9:"tab",13:"enter",32:"space",37:"left",38:"up",39:"right",40:"down",46:"del"},e.Events.Input.fromInput=function(t){return e.Events.Input.fromKeyDown(t)},e.Events.Input.fromKeyDown=function(t){var n="number"==typeof t.which?t.which:t.keyCode,i={key:e.Events.Input.keyDownNames[n]||n,keyCode:n,shift:t.shiftKey,alt:t.altKey,ctrl:t.ctrlKey,meta:t.metaKey};return new e.Events.Input(i)},t=e.Events.Input}(events_input),input_filters_caret=function(t){var e=input;return e.Filter.Caret=function(t){this._caret=t.getCaret()},function(){this.keys={left:"moveLeft",up:"moveUp",right:"moveRight",down:"moveDown"},this.moveLeft=function(t){this._caret.moveLeft(),t.cancel()},this.moveUp=function(t){this._caret.moveUp(),t.cancel()},this.moveRight=function(t){this._caret.moveRight(),t.cancel()},this.moveDown=function(t){this._caret.moveDown(),t.cancel()}}.call(e.Filter.Caret.prototype),t=e.Filter.Caret}(input_filters_caret),input_filters_undo=function(t){var e=input;return e.Filter.Undo=function(t,e){this._undoManager=t.getUndoManager(),this._sourceId=e.getContent().getSourceId()},function(){this.keys={90:"undoRedo"},this.undoRedo=function(t){t.cmd&&t.shift?(this._undoManager.redo(this._sourceId),t.cancel()):t.cmd&&(this._undoManager.undo(this._sourceId),t.cancel())}}.call(e.Filter.Undo.prototype),t=e.Filter.Undo}(input_filters_undo),input_filters_command=function(t){var e=input;return e.Filter.Command=function(t,e){this._selection=t.getSelection(),this._content=e.getContent()},function(){this.keys={66:"command",73:"command",83:"command",85:"command"},this.tags={66:"strong",73:"em",83:"s",85:"u"},this.command=function(t){var e;t.cmd&&(e=this._selection.save(),this._content.format(this.tags[t.key],this._selection.getRange()),this._selection.restore(e),t.cancel())}}.call(e.Filter.Command.prototype),t=e.Filter.Command}(input_filters_command),input_filters_remove=function(t){var e=input;return e.Filter.Remove=function(t,e){this._root=t.getRoot(),this._content=e.getContent(),this._caret=t.getCaret(),this._selection=t.getSelection()},function(){this.keys={backspace:"remove",del:"remove"},this.remove=function(t){var e,n,i,s;this._selection.collapsed()?(i="backspace"===t.key?-1:1,s="backspace"===t.key?-1:0,e=Type.Range.fromCaret(this._caret,i),n=this._caret.getOffset()+s):(e=this._selection.getRange(),n=e.getStartOffset(this._root),this._selection.unselect(),this._caret._blink()),this._caret.setOffset(n),this._content.remove(e)}}.call(e.Filter.Remove.prototype),t=e.Filter.Remove}(input_filters_remove),input_filters_line_breaks=function(t){var e=input;return e.Filter.LineBreaks=function(t,e){this._writer=t.getWriter(),this._caret=t.getCaret()},function(){this.keys={enter:"insertLineBreak"},this.insertLineBreak=function(t){var e=document.createElement("br");this._writer.insertHTML(this._caret.textNode,this._caret.offset,e),this._caret.moveRight(),t.cancel()}}.call(e.Filter.LineBreaks.prototype),t=e.Filter.LineBreaks}(input_filters_line_breaks),undo_manager=function(t){var e=core;return e.UndoManager=function(t){this._type=t,this._stack=[],this._pointer=0,this.lastActionReceived=null,this.mergeDebounce=500},function(){this.push=function(t){return this._stack.length=0===this._stack.length?0:this._pointer+1,this.shouldBeMerged(t)?this._stack[this._pointer].merge(t):(this._stack.push(t),this._pointer=this._stack.length-1),this.lastActionReceived=Date.now(),this},this.shouldBeMerged=function(t){return null===this.lastActionReceived?!1:Date.now()>this.lastActionReceived+this.mergeDebounce?!1:!(!this._stack.length||!this._stack[this._pointer].mergeable(t))},this.undo=function(t,e){for(e=void 0===e?1:e;e>0&&this._pointer>-1;)(this._stack[this._pointer].sourceId===t||void 0===t)&&(this._stack[this._pointer].undo(this._getCharacterShift()),e-=1),this._pointer-=1;return this},this.redo=function(t,e){var n=this._stack.length;for(e=void 0===e?1:e;e>0&&this._pointer<n;){if(this._pointer++,this._pointer>this._stack.length-1){this._pointer=this._stack.length-1;break}(this._stack[this._pointer].sourceId===t||void 0===t)&&(this._stack[this._pointer].execute(this._getCharacterShift()),e--)}return this},this._getCharacterShift=function(t){t=void 0===t?this._pointer+1:t;var e,n,i,s=this._stack.length-1,r=[];for(n=s;n>=t;n-=1)for(e=this._stack[n].getCharacterShift(),i=0;i<e.length;i++)r.push(e[i]);return r}}.call(e.UndoManager.prototype),t=e.UndoManager}(undo_manager),content=function(t){var e=core;return e.Content=function(t){this._sourceId=this._createUniqueSourceId(),this._undoManager=t.getUndoManager(),this._writer=t.getWriter(),this._formatter=t.getFormatter(),this._root=t.getRoot(),this._type=t},function(){this.insert=function(t,n,i){if(2===arguments.length){var s=e.TextWalker.nodeAt(this._root,t);i=n,n=s.offset,t=s.node}this._writer.insertText(t,n,i);var r=e.TextWalker.offset(this._root,t,0,n),o=new e.Actions.Insert(this._sourceId,this._type,r,i);return this._undoManager.push(o),this},this.remove=function(t,n){2===arguments.length&&(t=e.Range.fromPositions(this._root,t,t+n));var i=e.Actions.Remove.fromRange(this._sourceId,this._type,t);return this._undoManager.push(i),this._writer.remove(t),this},this.format=function(t,n,i){3===arguments.length&&(n=e.Range.fromPositions(this._root,n,i));var s=this._formatter.format(t,n),r=new e.Actions.Format.fromRange(this._sourceId,this._type,n,t,s);return this._undoManager.push(r),this},this.removeFormat=function(t,n,i){return 3===arguments.length&&(n=e.Range.fromPositions(this._root,n,i)),this._formatter.removeFormat(t,n),this},this.getSourceId=function(){return this._sourceId},this.getRoot=function(){return this._root},this._createUniqueSourceId=function(){return e.Content._lastSourceId=e.Content._lastSourceId||0,e.Content._lastSourceId+=1,e.Content._lastSourceId}}.call(e.Content.prototype),t=e.Content}(content),actions_type=function(t){var e=core;return e.Actions.Type=function(t,e){this.sourceId=t,this.undone=e||!1},function(){this.execute=function(){return this.undone=!1,this},this.undo=function(){return this.undone=!0,this},this.mergeable=function(t){return!1},this.merge=function(t){return this},this.getCharacterShift=function(){return[[0,0]]},this._getShiftTo=function(t,e){var n,i=0,s=e.length;for(n=0;s>n;n+=1)e[n][0]<=t&&(i+=e[n][1]);return i}}.call(e.Actions.Type.prototype),t=e.Actions.Type}(actions_type),actions_insert=function(t){var e=core;return e.Actions.Insert=function(t,e,n,i,s){this.sourceId=t,this.undone=s||!1,this._writer=e.getWriter(),this._caret=e.getCaret(),this._root=e.getRoot(),this.add(n,i)},e.OOP.inherits(e.Actions.Insert,e.Actions.Type),function(){this.execute=function(t){var n,i,s,r=this._stack.length;for(i=0;r>i;i+=1)s=this._getShiftTo(this._stack[i].start,t),n=e.TextWalker.nodeAt(this._root,this._stack[i].start+s),this._writer.insertText(n.node,n.offset,this._stack[i].text);return this._caret.setOffset(this._stack[r-1].end+s),this.undone=!1,this},this.undo=function(t){var n,i,s,r=this._stack.length;for(i=r-1;i>=0;i-=1)s=this._getShiftTo(this._stack[i].start,t),n=e.Range.fromPositions(this._root,this._stack[i].start+s,this._stack[i].end+s),this._writer.remove(n);return this._caret.setOffset(this._stack[0].start+s),this.undone=!0,this},this.mergeable=function(t){return t instanceof e.Actions.Insert},this.merge=function(t){var e,n=t.getStack(),i=n.length;for(e=0;i>e;e+=1)this.add(n[e].start,n[e].text);return this},this.getCharacterShift=function(){var t,e,n,i,s;if(this.undone)return[[0,0]];for(t=[],n=this._stack.length,s=0;n>s;s+=1)i=this._stack[s],e=[i.start,i.end-i.start],t.push(e);return t},this.add=function(t,e){var n,i,s,r=e.length,o=t+r;if(this._stack=this._stack||[],0===this._stack.length)return this._stack.push({start:t,end:o,text:e}),this;for(s=0;s<this._stack.length;s++){if(this._stack[s].start>o){this._stack.splice(s,0,{start:t,end:o,text:e});break}if(t>=this._stack[s].start&&t<=this._stack[s].end){n=this._stack[s].text,i=t-this._stack[s].start,this._stack[s].text=n.substr(0,i)+e+n.substr(i),this._stack[s].end+=r;break}if(s+1>=this._stack.length){this._stack.push({start:t,end:o,text:e});break}if(this._stack[s].end<t&&this._stack[s+1].start<o){this._stack.splice(s,0,{start:t,end:o,text:e});break}}return this},this.getStack=function(){return this._stack||[]}}.call(e.Actions.Insert.prototype),t=e.Actions.Insert}(actions_insert),actions_remove=function(t){var e=core;return e.Actions.Remove=function(t,e,n,i,s){this.sourceId=t,this.undone=s||!1,this._writer=e.getWriter(),this._caret=e.getCaret(),this._root=e.getRoot(),this.start=n,this.end=i,this._contents=this._getContents()},e.OOP.inherits(e.Actions.Remove,e.Actions.Type),function(){this.execute=function(t){var n=this._getShiftTo(this.start,t),i=e.Range.fromPositions(this._root,this.start+n,this.end+n);return this._writer.remove(i),this._caret.setOffset(this.start+n),this.undone=!1,this},this.undo=function(t){var n=this._getShiftTo(this.start,t),i=e.TextWalker.nodeAt(this._root,this.start+n);return this._writer.insertHTML(i.node,i.offset,this._contents),this._caret.setOffset(this.end+n),this.undone=!0,this},this.mergeable=function(t){return!1},this.merge=function(t){return this.start=Math.min(this.start,t.start),this.end=Math.max(this.end,t.end),this._contents=this._getContents(),this},this.getCharacterShift=function(){var t=this.start-this.end;return this.undone?[[0,0]]:[[this.start,t]]},this._getContents=function(){var t=e.Range.fromPositions(this._root,this.start,this.end);return t.getNativeRange().cloneContents().childNodes}}.call(e.Actions.Remove.prototype),e.Actions.Remove.fromRange=function(t,n,i){var s=i.save(n.getRoot());return new e.Actions.Remove(t,n,s.start,s.end)},t=e.Actions.Remove}(actions_remove),actions_format=function(t){var e=core;return e.Actions.Format=function(t,e,n,i,s,r,o){this.sourceId=t,this.undone=o||!1,this._formatter=e.getFormatter(),this._caret=e.getCaret(),this._root=e.getRoot(),this._start=n,this._end=i,this._tag=s,this._nodes=r},e.OOP.inherits(e.Actions.Format,e.Actions.Type),function(){this.execute=function(t){var n=this._getShiftTo(this._start,t),i=this._getShiftTo(this._end,t),s=e.Range.fromPositions(this._root,this._start+n,this._end+i);return this._nodes=this._formatter.format(this._tag,s),this.undone=!1,this},this.undo=function(t){var n,i=this._nodes.length;for(n=0;i>n;n+=1)e.DomUtilities.unwrap(this._nodes[n]);return this.undone=!0,this}}.call(e.Actions.Format.prototype),e.Actions.Format.fromRange=function(t,n,i,s,r){var o=i.save(n.getRoot());return new e.Actions.Format(t,n,o.start,o.end,s,r)},t=e.Actions.Format}(actions_format),core_api=function(t){var e=core;return function(){this.caret=function(t){return arguments.length?"show"===arguments[0]?(this._caret.show(),this):"hide"===arguments[0]?(this._caret.hide(),this):1===arguments.length&&"number"==typeof arguments[0]?(this._caret.setOffset(arguments[0]),this):2===arguments.length?this.selection(arguments[0],arguments[1]):this:this._caret.getOffset()},this.selection=function(t){return arguments.length&&"text"!==arguments[0]?"html"===arguments[0]?e.Range.fromCurrentSelection().html():1===arguments.length&&"number"==typeof arguments[0]?this.caret(arguments[0]):2===arguments.length&&"number"==typeof arguments[0]?(new e.Range(this.root,arguments[0],arguments[1]).select(),this):DomUtil.isNode(arguments[0])?(new e.Range(arguments[0]).select(),this):2===arguments.length&&DomUtil.isNode(arguments)?(new e.Range(arguments[0],arguments[1]).select(),this):arguments[0].jQuery?(new e.Range(arguments[0],arguments[1]).select(),this):"save"===arguments[0]?e.Range.fromCurrentSelection().save():"restore"===arguments[0]?e.Range.fromCurrentSelection().restore(arguments[1]):this:e.Range.fromCurrentSelection().text()},this.insert=function(t){return 1===arguments.length?(this.getInput().getContent().insert(this.getCaret().getOffset(),arguments[0]),this):2===arguments.length&&"text"===arguments[1]?(this.getInput().getContent().insert(this.getCaret().getOffset(),arguments[0]),this):2===arguments.length&&"number"==typeof arguments[1]?(this._writer.insertText(arguments[0],arguments[1]),this):3===arguments.length&&"html"===arguments[0]?(this._writer.insertHTML(arguments[1],arguments[2]),this):this},this.format=function(t){var n,i;return 1===arguments.length?(n=this._selection.save(),this.getInput().getContent().format(arguments[0],this._selection.getRange()),this._selection.restore(n),this):3===arguments.length?(i=e.Range.fromPositions(this.getRoot(),arguments[1],arguments[2]),this.getInput().getContent().format(arguments[0],i),this):this},this.remove=function(t){return arguments.length<2&&this.getInput().getContent().remove(this.getCaret().getOffset(),arguments[0]||-1),2===arguments.length&&this.getInput().getContent().remove(arguments[0],arguments[1]),this},this.undo=function(t){var e=this.getInput().getContent().getSourceId();return this.getUndoManager().undo(e,t),this},this.redo=function(t){var e=this.getInput().getContent().getSourceId();return this.getUndoManager().redo(e,t),this}}.call(e.fn),t}(core_api),plugins_etherpad_typeetherpad=function(t){var e=core;return e.Etherpad=function(t){this.options(t.options("etherpad")||{}),this._type=t,this._caret=t.getCaret(),this._client=new e.Etherpad.Client(this),this._client.onInit(this._initEditor.bind(this)),this._client.connect(),this._content=new e.Etherpad.Content(this)},function(){this._defaultOptions={host:"localhost",port:9001,rootPath:"/api/1.2.1/"},this.options=function(t,n){return this._options=this._options||e.Utilities.extend({},this._defaultOptions),"string"==typeof t&&1===arguments.length?this._options[t]:("string"==typeof t&&2===arguments.length&&(t={options:n}),"object"==typeof t&&e.Utilities.extend(this._options,t),arguments.length?this:this._options)},this.getType=function(){return this._type},this.getClient=function(){return this._client},this.getContent=function(){return this._content},this._initEditor=function(t,n){var i=this._initChangeset(t);return e.Development.log(i),this._type.getRoot().innerHTML=e.Etherpad.Util.nl2br(t.text),this._content.applyChangeset(i,n),this._startSending(),this},this._startSending=function(){return this._type.on("input",function(t){var n,i,s,r;n=String.fromCharCode(t.keyCode),n=t.shift?n:n.toLowerCase(),e.Development.log(n,t.keyCode),8==t.keyCode||46==t.keyCode?(r=this._caret.getOffset(),s=new e.Etherpad.Changeset.Changes.Removal(r,1),this._client.send(s)):/[a-zA-Z]/.test(n)&&(r=this._caret.getOffset(),i=new e.Etherpad.Changeset.Changes.Insertion(r,n),this._client.send(i))}.bind(this)),this},this._initChangeset=function(t){var e="Z:"+t.text.length.toString(36)+">0",n=t.attribs.replace(/\+/g,"="),i="$";return e+n+i}}.call(e.Etherpad.prototype),e.fromEtherpad=function(t,n,i){t=e.Etherpad.prepareOptions(t,n,i);var s=new e(t);return new e.Etherpad(s),s},e.Etherpad.prepareOptions=function(t,n,i){return t=t||{},n=n||{},e.DomUtilities.isNode(t)&&(t={el:t}),3===arguments.length&&(n={pad:n,server:i}),"string"==typeof n&&(n={pad:n}),t.etherpad=n,t},t=e.Etherpad}(plugins_etherpad_typeetherpad),plugins_etherpad_util=function(t){var e=core;return e.Etherpad.Util=function(){},function(){e.Etherpad.Util.nl2br=function(t){return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1<br />$2")},e.Etherpad.Util.getRandomToken=function(){for(var t,e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",n=20,i="",s=0;n>s;s++)t=Math.floor(Math.random()*e.length),i+=e.substring(t,t+1);return"t."+i}}.call(e.Etherpad.Util.prototype),t=e.Etherpad.Util}(plugins_etherpad_util),plugins_etherpad_client=function(t){var e=core;return e.Etherpad.Client=function(t){this._etherpad=t,this._msgHandlers={},this._accepted=!0,this._lastSent=Date.now(),this._changeset=new e.Etherpad.Changeset,this.registerMessageHandler("ACCEPT_COMMIT",this._acceptCommit.bind(this))},function(){this._defaultUrl="http://localhost:9001/",this._debounceTime=0,this.connect=function(){return this._socket=io.connect(this._url(),this._socketIoOptions()),this._socket.once("connect",this._sendClientReady.bind(this)),this._socket.on("message",this._handleMessage.bind(this)),this},this.onInit=function(t){return this._onInitHandler=t,this},this.registerMessageHandler=function(t,e){return this._msgHandlers[t]=this._msgHandlers[t]||[],this._msgHandlers[t].push(e),this},this.unregisterMessageHandler=function(t,e){var n;return this._msgHandlers[t]&&(n=this._msgHandlers[t].indexOf(e),n>-1&&this._msgHandlers[t].splice(n,1)),this},this.send=function(t){var n,i;return this._changeset._mergeOrPush(t),this._accepted&&Date.now()-this._debounceTime>this._lastSent&&(this._accepted=!1,n=this._etherpad.getContent().getRoot(),i=this._changeset.getString(n),this._sendChangeset(i),this._changeset=new e.Etherpad.Changeset,this._lastSent=Date.now()),this},this._acceptCommit=function(t){this._etherpad.getContent().setRevision(t.newRev),this._accepted=!0},this._sendChangeset=function(t){this._sendMessage({type:"USER_CHANGES",baseRev:this._etherpad.getContent().getRevision(),changeset:t,apool:{nextNum:1,numToAttrib:{0:["author",this._userId]}}})},this._sendMessage=function(t){this._socket.json.send({type:"COLLABROOM",component:"pad",data:t})},this._handleMessage=function(t){var n,i,s=t.data.type;if(e.Development.debug("message",t),"CLIENT_VARS"===t.type)return this._init(t.data),this;if(!this._msgHandlers[s])return e.Development.debug("Unhandled etherpad message",t),this;for(n=this._msgHandlers[s].length,i=0;n>i;i+=1)this._msgHandlers[s][i](t.data);return this},this._init=function(t){return this._etherpad.getContent().setRevision(t.collab_client_vars.rev),this._userId=t.userId,this._onInitHandler&&this._onInitHandler(t.collab_client_vars.initialAttributedText,t.collab_client_vars.apool),this},this._sendClientReady=function(){var t={isReconnect:!1,component:"pad",type:"CLIENT_READY",token:e.Etherpad.Util.getRandomToken(),padId:this._etherpad.options("pad"),sessionID:"null",password:null,protocolVersion:2};return this._socket.json.send(t),this},this._socketIoOptions=function(){return{path:"/socket.io",resource:"socket.io","max reconnection attempts":3,"sync disconnect on unload":!1}},this._url=function(){return this._etherpad.options("url")||this._defaultUrl}}.call(e.Etherpad.Client.prototype),t=e.Etherpad.Client}(plugins_etherpad_client),plugins_etherpad_content=function(t){var e=core;return e.Etherpad.Content=function(t){this._client=t.getClient(),this._localCaret=t.getType().getCaret(),this._typeContent=new e.Content(t.getType()),this._root=this._typeContent.getRoot(),this._client.registerMessageHandler("NEW_CHANGES",this.updateContent.bind(this))},function(){this.updateContent=function(t){return this.revision=t.newRev,this.applyChangeset(t.changeset,t.apool),this},this.applyChangeset=function(t,n){var i=new e.Etherpad.Changeset.fromString(t,n,this._root.textContent);return i.apply(this._typeContent,this._localCaret),this},this.getRevision=function(){return this.revision},this.setRevision=function(t){return this.revision=t,this},this.getRoot=function(){return this._root}}.call(e.Etherpad.Content.prototype),t=e.Etherpad.Content}(plugins_etherpad_content),plugins_etherpad_changeset=function(t){var e=core;return e.Etherpad.Changeset=function(){this._stack=[]},function(){this._changesetRegex=/((?:\*[0-9a-z]+)*)(?:\|([0-9a-z]+))?([-+=])([0-9a-z]+)|\?|/g,this.getString=function(t){var n=new e.Etherpad.ChangesetSerializer(this);return n.getString(t)},this.apply=function(t,e){var n,i=this._stack.length;for(n=0;i>n;n+=1)this._stack[n].apply(t,e);return this},this.addString=function(t,e,n){for(var i,s,r=this._getCharbank(t),o=this._getNlIndices(n),a={absolute:0,stack:[]};null!==(i=this._changesetRegex.exec(t));)(s=this._parseMatch(i))&&this._addMatchToStack(a,r,s,e,o);return this},this._getNlIndices=function(t){for(var e,n=/[\n]/gi,i=[];e=n.exec(t);)i.push(e.index);return i},this.getStack=function(){return this._stack},this._addMatchToStack=function(t,e,n,i,s){var r;return this._mergeOrPush(this._createFromMatch(t,e,n,i)),"="===n.operator&&(r=parseInt(n.value,36),r+=n.nl?1:0,t.absolute+=r,t.stack.push(t)),this},this._createFromMatch=function(t,n,i,s){var r=this._getAttributesFromMatch(i,s);switch(i.operator){case"*":return e.Etherpad.Changeset.Changes.Command.fromAPool(s);case"=":return this._operationOrMovement(t,n,i,r);case"+":return new e.Etherpad.Changeset.Changes.Insertion(t.absolute,n);case"-":return e.Etherpad.Changeset.Changes.Removal.fromMatch(t,i);default:return e.Development.debug("Cannot match operator "+i.operator,i),null}},this._operationOrMovement=function(t,n,i,s){return s.length?e.Etherpad.Changeset.Changes.Formatting.fromAttrs(s,t.absolute,i):e.Etherpad.Changeset.Changes.Movement.fromOffsetObject(t,i)},this._mergeOrPush=function(t){var n=this._stack[this._stack.length-1];return n&&n.mergable(t)?n.merge(t):t instanceof e.Etherpad.Changeset.Changes.Movement||this._stack.push(t),this},this._parseMatch=function(t){return t.index===this._changesetRegex.lastIndex&&this._changesetRegex.lastIndex++,""===t[0]?!1:{attrs:t[1],nl:t[2],operator:t[3],value:t[4]}},this._getAttributesFromMatch=function(t,e){var n;return t.attrs.length?(n=parseInt(t.attrs.substr(1)),[e.numToAttrib[n]]):[]},this._getCharbank=function(t){var e=t.indexOf("$")+1;return e>=0?t.substring(e):null}}.call(e.Etherpad.Changeset.prototype),e.Etherpad.Changeset.fromString=function(t,n,i){var s=new e.Etherpad.Changeset;return s.addString(t,n,i),s},e.Etherpad.Changeset.Changes={},t=e.Etherpad.Changeset}(plugins_etherpad_changeset),plugins_etherpad_changes_change=function(t){var e=core;return e.Etherpad.Changeset.Changes.Change=function(){},function(){this.apply=function(t,e){return this},this.mergable=function(t){return!1},this.merge=function(t){return this},this.getCharbank=function(){return""},this.getOperation=function(){return""},this.getLength=function(){return 0}}.call(e.Etherpad.Changeset.Changes.Change.prototype),e.Etherpad.Changeset.Changes.Change.fromMatch=function(t){return new e.Etherpad.Changeset.Changes.Change},t=e.Etherpad.Changeset.Changes.Change}(plugins_etherpad_changes_change),plugins_etherpad_changes_movement=function(t){var e=core;return e.Etherpad.Changeset.Changes.Movement=function(t,e){this.delta=t,this.absolute=e||null},e.OOP.inherits(e.Etherpad.Changeset.Changes.Movement,e.Etherpad.Changeset.Changes.Change),function(){this.op="="}.call(e.Etherpad.Changeset.Changes.Movement.prototype),e.Etherpad.Changeset.Changes.Movement.fromMatch=function(t){return new e.Etherpad.Changeset.Changes.Movement(parseInt(t.value,36))},e.Etherpad.Changeset.Changes.Movement.fromOffsetObject=function(t,n){var i=t.stack[t.stack.length-1];return new e.Etherpad.Changeset.Changes.Movement(i,t.absolute+parseInt(n.value))},t=e.Etherpad.Changeset.Changes.Movement}(plugins_etherpad_changes_movement),plugins_etherpad_changes_insertion=function(t){var e=core;return e.Etherpad.Changeset.Changes.Insertion=function(t,e){this.start=t,this.length=e.length,this.end=t+e.length,this.text=e},e.OOP.inherits(e.Etherpad.Changeset.Changes.Insertion,e.Etherpad.Changeset.Changes.Change),function(){this.op="+",this.getOperation=function(){return this.op+this.text.length},this.getLength=function(){return this.length},this.apply=function(t,e){return t.insert(this.start,this.text),e.moveBy(this.length),this},this.mergable=function(t){return t instanceof e.Etherpad.Changeset.Changes.Insertion&&this.start<=t.start&&t.start<=this.end},this.merge=function(t){var e=t.start-this.start;return this.text=this.text.substr(0,e)+t.text+this.text.substr(e),this}}.call(e.Etherpad.Changeset.Changes.Insertion.prototype),t=e.Etherpad.Changeset.Changes.Insertion}(plugins_etherpad_changes_insertion),plugins_etherpad_changes_removal=function(t){var e=core;return e.Etherpad.Changeset.Changes.Removal=function(t,e){this.start=t,this.length=e,this.end=t+e},e.OOP.inherits(e.Etherpad.Changeset.Changes.Removal,e.Etherpad.Changeset.Changes.Change),function(){this.op="-",this.getOperation=function(){return this.op+this.length},this.getLength=function(){return-1*this.length},this.apply=function(t,e){return t.remove(this.start,this.length),this.end<=e.getOffset()&&e.moveBy(-1*this.length),this}}.call(e.Etherpad.Changeset.Changes.Removal.prototype),e.Etherpad.Changeset.Changes.Removal.fromMatch=function(t,n){
return new e.Etherpad.Changeset.Changes.Removal(t.absolute,parseInt(n.value,36))},t=e.Etherpad.Changeset.Changes.Removal}(plugins_etherpad_changes_removal),plugins_etherpad_changes_formatting=function(t){var e=core;return e.Etherpad.Changeset.Changes.Formatting=function(t,e,n,i){this.command=t,this.start=e,this.length=n,this.end=e+n,this.remove=!!i},e.OOP.inherits(e.Etherpad.Changeset.Changes.Formatting,e.Etherpad.Changeset.Changes.Change),function(){this.op="=",this._tagMap={bold:"strong",italic:"em",underline:"u",strikethrough:"s"},this.apply=function(t,e){return"author"!==this.command&&t.format(this._tagMap[this.command],this.start,this.end),this}}.call(e.Etherpad.Changeset.Changes.Formatting.prototype),e.Etherpad.Changeset.Changes.Formatting.fromAttrs=function(t,n,i){return new e.Etherpad.Changeset.Changes.Formatting(t[0][0],n,parseInt(i.value),!t[0][1])},t=e.Etherpad.Changeset.Changes.Formatting}(plugins_etherpad_changes_formatting),plugins_etherpad_changeset_serializer=function(t){var e=core;return e.Etherpad.ChangesetSerializer=function(t){this._operations=this._getOperations(t)},function(){this.getString=function(t){var e,n,i;for(n=this._operations.length,e=this._baseLengthString(t),e+=this._lengthChangeString(),e+=this._operationString(this._operations[0],null,t),i=1;n>i;i+=1)e+=this._operationString(this._operations[i],this._operations[i-1]);return e+=this._charbankString()},this._baseLengthString=function(t){return"Z:"+this._lengthFor(t).toString(36)},this._lengthChangeString=function(){var t=this._countLengthChange();return(t>0?">":"<")+Math.abs(t).toString()},this._operationString=function(t,e,n){var i,s,r;return i=this._offsetString(t,e,n),s="+"==t.op?"*0":"",r=/^[\n\r]+$/.test(t.text||"")?"|1+1":t.getOperation(),i+s+r},this._charbankString=function(){var t,e,n;for(t="$",e=this._operations.length,n=0;e>n;n+=1)t+=this._operationCharbankString(this._operations[n]);return t},this._operationCharbankString=function(t){return t.text?t.text:""},this._offsetString=function(t,e,n){var i=t.start-(e?e.start:0);return i>0?"="+i.toString(36):""},this._getNlIndices=function(t){for(var e,n=/[\n]/gi,i=[];e=n.exec(t);)i.push(e.index);return i},this._lengthFor=function(t){var e,n,i=0;for(e=this._operations.length,n=0;e>n;n+=1)i+=this._operations[n].getLength()||0;return 0>i&&(i+=3),"string"==typeof t?t.length+i:t.textContent?t.textContent.length-1+i:null},this._countLengthChange=function(){var t,e,n=0;for(t=this._operations.length,e=0;t>e;e+=1)n+=this._operations[e].getLength()||0;return n},this._getOperations=function(t){var e=t.getStack().slice(0);return e.sort(this._compareOperations),e},this._compareOperations=function(t,e){return t.start<e.start?-1:t.start>e.start?1:0}}.call(e.Etherpad.ChangesetSerializer.prototype),t=e.Etherpad.ChangesetSerializer}(plugins_etherpad_changeset_serializer),type=function(t){var e=core;return window.Type=e,t}(type);